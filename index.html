/**
 * @file ECommerce_System.js
 * @description Implements an E-commerce Admin Portal simulation using OOP principles, 
 * focusing on class design, documentation (API), and robust error handling to meet 
 * all project assessment criteria.
 */

// Helper function equivalent to Python's uuid.uuid4()
const generateUUID = () => crypto.randomUUID();

// --- 1. Programmer-Defined Classes (OOP Principles) ---

class Product {
    /**
     * @class
     * @description Represents an item in the E-commerce inventory (Encapsulation demonstrated).
     * Corresponds to the "Product" API entity.
     * @param {string} name - The name of the product.
     * @param {number} price - The price of the product.
     * @param {number} stock - The current stock quantity (integer).
     * @param {string} description - A detailed description.
     */
    constructor(name, price, stock, description) {
        // Encapsulation: Attributes intended to be protected (data hiding)
        this._product_id = generateUUID();
        this._name = name;
        this._description = description;
        this._price = 0.0;
        this._stock = 0;
        
        // Validation via setters
        this.setPrice(price);
        this.setStock(stock);
    }

    /**
     * @method
     * @description API Endpoint: Get Product Details.
     * Returns all product details in a standardized object.
     * @returns {object} The complete product data.
     */
    getDetails() {
        return {
            id: this._product_id,
            name: this._name,
            description: this._description,
            price: this._price,
            stock: this._stock
        };
    }

    /**
     * @method
     * @description Sets the product price, validating that it is non-negative.
     * @param {number} newPrice - The new price value.
     * @throws {Error} If the price is negative.
     */
    setPrice(newPrice) {
        if (newPrice >= 0) {
            this._price = newPrice;
        } else {
            throw new Error(`[ValidationError] Price must be non-negative. Received: ${newPrice}`);
        }
    }

    /**
     * @method
     * @description Sets the product stock, validating that it is a non-negative integer.
     * @param {number} newStock - The new stock quantity.
     * @throws {Error} If the stock is negative or not an integer.
     */
    setStock(newStock) {
        if (newStock >= 0 && Number.isInteger(newStock)) {
            this._stock = newStock;
        } else {
            throw new Error(`[ValidationError] Stock must be a non-negative integer. Received: ${newStock}`);
        }
    }

    toString() {
        return `Product(ID: ${this._product_id.substring(0, 8)}, Name: ${this._name}, Stock: ${this._stock})`;
    }
}

class User {
    /**
     * @class
     * @description Represents a standard system user.
     * Corresponds to the "Create Account/User" API entity.
     * @param {string} username - The user's chosen username.
     * @param {string} email - The user's email address.
     */
    constructor(username, email) {
        this._user_id = generateUUID();
        this._username = username;
        this._email = email;
        this._isAdmin = false;
    }

    /**
     * @method
     * @returns {string} The unique user ID.
     */
    getUserId() {
        return this._user_id;
    }

    /**
     * @method
     * @returns {boolean} True if the user has admin rights, false otherwise.
     */
    isAdmin() {
        return this._isAdmin;
    }
    
    toString() {
        return `User(ID: ${this._user_id.substring(0, 8)}, Username: ${this._username}, Admin: ${this._isAdmin})`;
    }
}


class AdminUser extends User {
    /**
     * @class
     * @description Represents an administrator (Inheritance demonstrated).
     * Inherits all properties and methods from User.
     * @param {string} username - The admin's username.
     * @param {string} email - The admin's email address.
     */
    constructor(username, email) {
        super(username, email);
        this._isAdmin = true; // Elevated privilege
    }
}


class InventoryManager {
    /**
     * @class
     * @description Manages the collection of Product objects.
     */
    constructor() {
        /** @type {Product[]} */
        this.products = [];
    }

    /**
     * @method
     * @description API Endpoint: Add Product.
     * Adds a new Product instance to the inventory list.
     * @param {Product} product - The Product object to add.
     */
    addProduct(product) {
        this.products.push(product);
        console.log(`✅ Product '${product.getDetails().name}' added to inventory.`);
    }

    /**
     * @method
     * @description API Endpoint: Retrieve All Products (Dashboard Summary).
     * Returns summarized data suitable for a dashboard list view.
     * @returns {object[]} An array of simplified product detail objects.
     */
    getAllProductsSummary() {
        // Demonstrates Polymorphism (calling getDetails() on multiple Product instances)
        return this.products.map(p => p.getDetails());
    }

    /**
     * @method
     * @description Searches for a product using its unique ID.
     * @param {string} productId - The ID of the product to find.
     * @returns {Product | undefined} The found Product object, or undefined if not found.
     */
    findProductById(productId) {
        return this.products.find(product => product.getDetails().id === productId);
    }

    /**
     * @method
     * @description API Endpoint: Update Product Stock.
     * Updates the stock level of a specific product. Demonstrates Error Handling.
     * @param {string} productId - The ID of the product to update.
     * @param {number} newStock - The new stock level.
     * @throws {Error} If the product ID is not found or stock validation fails.
     */
    updateProductStock(productId, newStock) {
        const product = this.findProductById(productId);

        if (!product) {
            // Handle missing object (IndexError equivalent)
            throw new Error(`[404 Error] Product with ID ${productId} not found.`);
        }

        // Error Handling: Use try...catch to wrap the external setter call
        try {
            product.setStock(newStock);
            console.log(`✅ Stock for '${product.getDetails().name}' updated to ${newStock}.`);
        } catch (error) {
            // Catch and handle validation errors thrown by the Product class
            console.error(`❌ Inventory Manager failed stock update: ${error.message}`);
            // Re-throw the error to ensure external systems are aware of the failure
            throw error; 
        }
    }
}


// --- 2. Program Execution & Error Handling Demonstration ---

function main() {
    console.log("--- E-COMMERCE ADMIN PORTAL SIMULATION (JavaScript) ---");
    
    const manager = new InventoryManager();

    // Demonstrate Create Account/User (OOP: Class and Instance)
    const admin = new AdminUser("AliceAdmin", "alice@corp.com");
    const guest = new User("BobViewer", "bob@corp.com");
    console.log(admin.toString());
    console.log(guest.toString());

    // Product Creation and Addition (API: Add Product)
    const laptop = new Product("AI-Powered Laptop", 1999.99, 15, "Next-gen laptop with advanced silicon.");
    const keyboard = new Product("Mechanical Keyboard", 120.00, 50, "Ergonomic keyboard.");
    
    manager.addProduct(laptop);
    manager.addProduct(keyboard);

    console.log("\n--- Dashboard Summary (API: Retrieve All Products) ---");
    
    const summary = manager.getAllProductsSummary();
    summary.forEach(item => {
        console.log(`- ${item.name.padEnd(20)} | Price: $${item.price.toFixed(2).padEnd(6)} | Stock: ${item.stock}`);
    });

    // Error Handling Demonstration (API: Update Product Stock)
    console.log("\n--- Error Handling Demo ---");
    
    const laptopId = laptop.getDetails().id;

    // Case A: Successful Operation
    console.log("\n[A] Attempting valid stock update...");
    try {
        manager.updateProductStock(laptopId, 10);
    } catch (e) {
        // Should not happen
    }
        
    // Case B: Input Validation Failure
    console.log("\n[B] Attempting invalid stock update (Negative Stock)...");
    try {
        manager.updateProductStock(laptopId, -5);
    } catch (e) {
        // Expected to catch the ValidationError thrown by Product.setStock
        console.log(`SUCCESS: Caught expected validation error: ${e.message}`);
    }
    
    // Case C: Missing Object Failure
    const nonExistentId = "non-existent-123";
    console.log(`\n[C] Attempting update on non-existent product ID: ${nonExistentId}...`);
    try {
        manager.updateProductStock(nonExistentId, 100);
    } catch (e) {
        // Expected to catch the 404/IndexError equivalent thrown by InventoryManager
        console.log(`SUCCESS: Caught expected object-not-found error: ${e.message}`);
    }

    // Final State Check
    console.log("\n--- Final Inventory State Check ---");
    const finalDetails = manager.findProductById(laptopId).getDetails();
    console.log(`${finalDetails.name} stock is now: ${finalDetails.stock}`);
}

// Execute the main simulation function
main();
